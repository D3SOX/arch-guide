(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{384:function(t,e,a){"use strict";a.r(e);var s=a(26),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"encryption"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#encryption"}},[t._v("#")]),t._v(" Encryption")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),a("p",[t._v("This guide will mostly care for UEFI systems. Steps shouldn't be much different for non-UEFI systems. Have a look at the\narch wiki regarding "),a("a",{attrs:{href:"https://wiki.archlinux.org/index.php/Dm-crypt",target:"_blank",rel:"noopener noreferrer"}},[t._v("system encryption"),a("OutboundLink")],1),t._v(" for more information.")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v('This guide uses X, Y and Z as placeholders. Adjust them accordingly to your setup. Additionally, "sd" could be different depending\non the used connection method of your drive.')])]),t._v(" "),a("p",[t._v("In this guide, the encryption configuration we want to achieve is this:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("                |----------|----------------------|\n                |   Swap   |   Other partitions   |\n                |          |   e.g. / or /home    |\n|---------------|---------------------------------|\n|   Grub boot   |   Encrypted container (LUKS)    |\n|---------------|---------------------------------|\n")])])]),a("p",[t._v("At first, we have a "),a("code",[t._v("/boot")]),t._v(" partition that contains the Grub bootloader as well as the necessary files for UEFI.\nThen we have an encrypted container that uses LUKS that contains the swap and other partitions, like the root partition or "),a("code",[t._v("/home")]),t._v(".\nAll your data as well as the system will be encrypted as a result of that.")]),t._v(" "),a("p",[t._v("This results in you having to type in a password directly after booting, which will unlock the encrypted LUKS container and then boot\nthe system normally.")]),t._v(" "),a("h2",{attrs:{id:"partitioning"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#partitioning"}},[t._v("#")]),t._v(" Partitioning")]),t._v(" "),a("p",[t._v("To get a brief overview of the disks, use the command")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fdisk")]),t._v(" -l\n")])])]),a("p",[t._v("After you got the disk to use, run")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("gdisk /dev/sdX\n")])])]),a("p",[t._v("to partition the disk accordingly. For more information on how to use gdisk, see the "),a("a",{attrs:{href:"https://wiki.archlinux.org/index.php/GPT_fdisk",target:"_blank",rel:"noopener noreferrer"}},[t._v("arch wiki"),a("OutboundLink")],1),t._v(".\nFor completeness, the most used commands are:")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Command")]),t._v(" "),a("th",[t._v("What does this do?")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("o")])]),t._v(" "),a("td",[t._v("New partition table")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("n")])]),t._v(" "),a("td",[t._v("Create new partition")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("w")])]),t._v(" "),a("td",[t._v("Write table to disk")])])])]),t._v(" "),a("p",[t._v("After partitioning, you want to have a layout that looks like this:")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Partition")]),t._v(" "),a("th",[t._v("Usage")]),t._v(" "),a("th",[t._v("Size")]),t._v(" "),a("th",[t._v("Partition code")]),t._v(" "),a("th",[t._v("Partition type")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("/dev/sdXY")])]),t._v(" "),a("td",[t._v("Grub boot")]),t._v(" "),a("td",[t._v("Depends, "),a("RouterLink",{attrs:{to:"/installation/partitioning-formatting.html#efi-system"}},[t._v("300M are recommended")])],1),t._v(" "),a("td",[a("code",[t._v("ef00")])]),t._v(" "),a("td",[t._v("EFI System")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("/dev/sdXZ")])]),t._v(" "),a("td",[t._v("LUKS container")]),t._v(" "),a("td",[t._v("Remaining")]),t._v(" "),a("td",[a("code",[t._v("8E00")])]),t._v(" "),a("td",[t._v("Linux Filesystem")])])])]),t._v(" "),a("h2",{attrs:{id:"the-crypt-container"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-crypt-container"}},[t._v("#")]),t._v(" The crypt container")]),t._v(" "),a("h3",{attrs:{id:"create-crypt-container"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-crypt-container"}},[t._v("#")]),t._v(" Create crypt container")]),t._v(" "),a("p",[t._v("Now we create a crypt container on "),a("code",[t._v("sdXZ")]),t._v(" using LUKS. For more information, see these two pages on the arch wiki regarding dm-crypt:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#LVM_on_LUKS",target:"_blank",rel:"noopener noreferrer"}},[t._v("Encrypting an entire system: LVM on LUKS"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption#Encryption_options_for_LUKS_mode",target:"_blank",rel:"noopener noreferrer"}},[t._v("Device encryption: Encryption options for LUKS mode"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("Encrypt "),a("code",[t._v("dev/sdXZ")]),t._v(". You will be prompted for a password. "),a("strong",[t._v("Care for different keyboard layouts when typing in the password!")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("cryptsetup luksFormat -c aes-xts-plain64 -s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("512")]),t._v(" /dev/sdXZ\n")])])]),a("p",[t._v("Now open the encrypted container and map it to the device "),a("code",[t._v("cryptroot")]),t._v(". You will be prompted for the encryption password.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("cryptsetup "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),t._v(" /dev/sdXZ cryptroot\n")])])]),a("h3",{attrs:{id:"creating-lvm-within-the-luks-container"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#creating-lvm-within-the-luks-container"}},[t._v("#")]),t._v(" Creating LVM within the LUKS container")]),t._v(" "),a("p",[t._v("We currently have an (open and) encrypted container, but no LVM inside. To do this, we first have to create a volume group.\nWe will call it "),a("code",[t._v("main")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("vgcreate main /dev/mapper/cryptroot\n")])])]),a("p",[t._v("Now we create the partitions we need. Since we just want a swap partition and a root partition, we need these two commands. If you want\nadditional partitions, e.g. for a separate home partition, adjust the following commands (in the other sections, too) according to your\nneeds. For recommendations regarding the swap size, see the "),a("RouterLink",{attrs:{to:"/installation/partitioning-formatting.html#swap"}},[t._v("partitioning section of this guide")]),t._v(".")],1),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("lvcreate -L 32G main -n swap\nlvcreate -l "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("%FREE main -n root\n")])])]),a("h3",{attrs:{id:"create-the-filesystems"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-the-filesystems"}},[t._v("#")]),t._v(" Create the filesystems")]),t._v(" "),a("p",[t._v("Now we format the newly created volumes and partitions. The UEFI partition needs to be of type "),a("code",[t._v("fat32")]),t._v(". Additionally, this will get you\na "),a("code",[t._v("ext4")]),t._v(" root partition. You can adjust this freely if you like.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("mkfs.fat -F "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v(" /dev/sdXY\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkswap")]),t._v(" /dev/mapper/main-swap\nmkfs.ext4 /dev/mapper/main-root\n")])])]),a("h3",{attrs:{id:"mounting-the-system"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mounting-the-system"}},[t._v("#")]),t._v(" Mounting the system")]),t._v(" "),a("p",[t._v("Mount the system")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),t._v(" /dev/mapper/main-root /mnt\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /mnt/boot\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),t._v(" /dev/sda1 /mnt/boot\n")])])]),a("p",[t._v("Additionally, enable the swap")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("swapon")]),t._v(" /dev/mapper/main-swap\n")])])]),a("p",[t._v("When following the guide for a normal installation, you can go back to the "),a("RouterLink",{attrs:{to:"/installation/base-installation.html"}},[t._v("base installation page")]),t._v(" now.")],1),t._v(" "),a("h2",{attrs:{id:"adjust-linux-kernel-hooks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#adjust-linux-kernel-hooks"}},[t._v("#")]),t._v(" Adjust linux kernel hooks")]),t._v(" "),a("p",[t._v("Edit the file "),a("code",[t._v("/etc/mkinitcpio.conf")]),t._v(" to contain the following line")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("HOOKS=(base udev autodetect modconf block filesystems keyboard keymap encrypt lvm2 fsck)\n")])])]),a("p",[t._v("After that, run the command to create the initial ramdisk environment")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("mkinitcpio -P\n")])])]),a("h2",{attrs:{id:"install-grub"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-grub"}},[t._v("#")]),t._v(" Install grub")]),t._v(" "),a("p",[t._v("Before installing grub, we have to mount the efi variables and install important packages")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),t._v(" -t efivarfs efivarfs /sys/firmware/efi/efivars\npacman -S grub efibootmgr dosfstools\n")])])]),a("p",[t._v("Additionally, install the microcode packages for your cpu, e.g. "),a("code",[t._v("intel-ucode")]),t._v(" or "),a("code",[t._v("amd-ucode")]),t._v(".")]),t._v(" "),a("p",[t._v("Now find the UUID of the boot partition (in the line starting with "),a("code",[t._v("/dev/sdXY")]),t._v(") and note it down")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("blkid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UUID="')]),t._v("\n")])])]),a("p",[t._v("Adjust "),a("code",[t._v("/etc/default/grub")]),t._v(" because of the encryption. Replace "),a("code",[t._v("<UUID>")]),t._v(" with the UUID of the device you found earlier.")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('GRUB_CMDLINE_LINUX="cryptdevice=UUID=<UUID>:main root=/dev/mapper/main-root"\n')])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("If you want to type the password with the keyboard layout of your home country, you can adjust the line like this with\nthe languages of your choice. This example uses the german keyboard layout.")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('GRUB_CMDLINE_LINUX="cryptdevice=UUID=<UUID>:main root=/dev/mapper/main-root lang=de locale=de_DE.UTF-8"\n')])])])]),t._v(" "),a("p",[t._v("After that, you can install grub. Use the following commands to do that. "),a("strong",[t._v("Make sure no errors are reported here.")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=arch_grub --recheck --debug\ngrub-mkconfig -o /boot/grub/grub.cfg\n")])])]),a("p",[t._v("When following the guide for a normal installation, you can go back to the "),a("RouterLink",{attrs:{to:"/installation/configure-system.html"}},[t._v("configure system page")]),t._v(" now.")],1),t._v(" "),a("h2",{attrs:{id:"additional-resources"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#additional-resources"}},[t._v("#")]),t._v(" Additional resources")]),t._v(" "),a("p",[t._v("For more information, you can visit the following pages:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://wiki.archlinux.org/index.php/Dm-crypt",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://wiki.archlinux.org/index.php/Dm-crypt"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.timoschindler.de/arch-linux-uefi-boot-mit-grub-und-verschluesseltem-lvm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.timoschindler.de/arch-linux-uefi-boot-mit-grub-und-verschluesseltem-lvm/"),a("OutboundLink")],1),t._v(" (German)")])]),t._v(" "),a("p",[t._v("This guide tries to sum them all up in one neat page.")])])}),[],!1,null,null,null);e.default=n.exports}}]);